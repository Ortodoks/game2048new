<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ª–µ–¥—è–Ω–æ–≥–æ —Å–∫–∏–Ω–∞</title>
    <style>
        body {
            background: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #764ba2;
        }
        .result {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #78dbff;
            font-family: monospace;
        }
        .success { border-left-color: #4ade80; }
        .error { border-left-color: #f87171; }
        .warning { border-left-color: #fbbf24; }
    </style>
</head>
<body>
    <h1>‚ùÑÔ∏è –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –õ–ï–î–Ø–ù–û–ì–û –°–ö–ò–ù–ê</h1>
    
    <div class="test-section">
        <h2>1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h2>
        <button onclick="checkCurrentState()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
        <div id="current-state-result"></div>
    </div>

    <div class="test-section">
        <h2>2Ô∏è‚É£ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–∫–∏–Ω–æ–≤</h2>
        <button onclick="unlockAllSkins()">üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–∫–∏–Ω—ã</button>
        <div id="unlock-result"></div>
    </div>

    <div class="test-section">
        <h2>3Ô∏è‚É£ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–µ–¥—è–Ω–æ–≥–æ —Å–∫–∏–Ω–∞</h2>
        <button onclick="applyIceSkin()">‚ùÑÔ∏è –ü–†–ò–ú–ï–ù–ò–¢–¨ –õ–ï–î–Ø–ù–û–ô –°–ö–ò–ù</button>
        <div id="apply-result"></div>
    </div>

    <div class="test-section">
        <h2>4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è</h2>
        <button onclick="verifyIceSkin()">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–∫–∏–Ω –ø—Ä–∏–º–µ–Ω–µ–Ω</button>
        <div id="verify-result"></div>
    </div>

    <div class="test-section">
        <h2>5Ô∏è‚É£ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É</h2>
        <button onclick="goToGame()">üéÆ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É</button>
    </div>

    <script>
        function log(elementId, message, type = 'result') {
            const el = document.getElementById(elementId);
            el.innerHTML += `<div class="result ${type}">${message}</div>`;
        }

        function checkCurrentState() {
            const resultId = 'current-state-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è...', 'result');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ userManager
                if (window.opener && window.opener.userManager) {
                    const um = window.opener.userManager;
                    log(resultId, `‚úÖ userManager –Ω–∞–π–¥–µ–Ω`, 'success');
                    log(resultId, `üìã –ê–∫—Ç–∏–≤–Ω—ã–π —Å–∫–∏–Ω: ${um.settings.activeSkin || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`, 'result');
                    log(resultId, `üìã –ö—É–ø–ª–µ–Ω–Ω—ã–µ —Å–∫–∏–Ω—ã: ${um.settings.purchasedSkins.join(', ')}`, 'result');
                } else {
                    log(resultId, `‚ùå userManager –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
                const lsSkin = localStorage.getItem('currentSkin');
                log(resultId, `üìã localStorage currentSkin: ${lsSkin || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`, 'result');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM
                if (window.opener && window.opener.document) {
                    const bodySkin = window.opener.document.body.getAttribute('data-skin');
                    const htmlSkin = window.opener.document.documentElement.getAttribute('data-skin');
                    log(resultId, `üìã body[data-skin]: ${bodySkin || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`, 'result');
                    log(resultId, `üìã html[data-skin]: ${htmlSkin || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`, 'result');
                }

            } catch (error) {
                log(resultId, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function unlockAllSkins() {
            const resultId = 'unlock-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–∫–∏–Ω–æ–≤...', 'result');
            
            try {
                if (window.opener && window.opener.userManager) {
                    window.opener.userManager.settings.purchasedSkins = [
                        'default', 'neon', 'gold', 'space', 'nature', 'fire', 'ice', 'rainbow'
                    ];
                    window.opener.userManager.saveSettings();
                    log(resultId, `‚úÖ –í—Å–µ —Å–∫–∏–Ω—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!`, 'success');
                    log(resultId, `üìã –°–ø–∏—Å–æ–∫: default, neon, gold, space, nature, fire, ice, rainbow`, 'success');
                } else {
                    log(resultId, `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ userManager`, 'error');
                }
            } catch (error) {
                log(resultId, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function applyIceSkin() {
            const resultId = 'apply-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, '‚ùÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–µ–¥—è–Ω–æ–≥–æ —Å–∫–∏–Ω–∞...', 'result');
            
            try {
                const opener = window.opener;
                
                if (!opener) {
                    log(resultId, `‚ùå –û–∫–Ω–æ –∏–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –∏–≥—Ä—ã!`, 'error');
                    return;
                }

                // 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ userManager
                if (opener.userManager) {
                    opener.userManager.settings.activeSkin = 'ice';
                    opener.userManager.saveSettings();
                    log(resultId, `‚úÖ –°–∫–∏–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ userManager`, 'success');
                }

                // 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
                localStorage.setItem('currentSkin', 'ice');
                opener.localStorage.setItem('currentSkin', 'ice');
                log(resultId, `‚úÖ –°–∫–∏–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage`, 'success');

                // 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ DOM
                opener.document.documentElement.setAttribute('data-skin', 'ice');
                opener.document.body.setAttribute('data-skin', 'ice');
                log(resultId, `‚úÖ data-skin="ice" –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ html –∏ body`, 'success');

                // 4. –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ graphics
                if (opener.graphics) {
                    opener.graphics.currentSkin = 'ice';
                    opener.graphics.applySkin('ice');
                    log(resultId, `‚úÖ graphics.applySkin('ice') –≤—ã–∑–≤–∞–Ω`, 'success');
                }

                // 5. –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ shop
                if (opener.shop) {
                    opener.shop.currentSkin = 'ice';
                    opener.shop.populateSkins();
                    log(resultId, `‚úÖ shop –æ–±–Ω–æ–≤–ª–µ–Ω`, 'success');
                }

                // 6. –§–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
                const gameBoard = opener.document.getElementById('game-board');
                if (gameBoard) {
                    gameBoard.style.display = 'none';
                    gameBoard.offsetHeight; // force reflow
                    gameBoard.style.display = '';
                    log(resultId, `‚úÖ –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–∞`, 'success');
                }

                log(resultId, `üéâ –õ–ï–î–Ø–ù–û–ô –°–ö–ò–ù –ü–†–ò–ú–ï–ù–ï–ù!`, 'success');
                log(resultId, `‚ùÑÔ∏è –ó–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –∏–≥—Ä—É`, 'success');

            } catch (error) {
                log(resultId, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function verifyIceSkin() {
            const resultId = 'verify-result';
            document.getElementById(resultId).innerHTML = '';
            
            log(resultId, '‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è...', 'result');
            
            try {
                const opener = window.opener;
                
                if (!opener) {
                    log(resultId, `‚ùå –û–∫–Ω–æ –∏–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`, 'error');
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∏
                const checks = [
                    {
                        name: 'userManager.activeSkin',
                        value: opener.userManager?.settings.activeSkin,
                        expected: 'ice'
                    },
                    {
                        name: 'localStorage.currentSkin',
                        value: opener.localStorage.getItem('currentSkin'),
                        expected: 'ice'
                    },
                    {
                        name: 'body[data-skin]',
                        value: opener.document.body.getAttribute('data-skin'),
                        expected: 'ice'
                    },
                    {
                        name: 'html[data-skin]',
                        value: opener.document.documentElement.getAttribute('data-skin'),
                        expected: 'ice'
                    },
                    {
                        name: 'graphics.currentSkin',
                        value: opener.graphics?.currentSkin,
                        expected: 'ice'
                    }
                ];

                let allPassed = true;
                checks.forEach(check => {
                    if (check.value === check.expected) {
                        log(resultId, `‚úÖ ${check.name}: ${check.value}`, 'success');
                    } else {
                        log(resultId, `‚ùå ${check.name}: ${check.value} (–æ–∂–∏–¥–∞–ª–æ—Å—å: ${check.expected})`, 'error');
                        allPassed = false;
                    }
                });

                if (allPassed) {
                    log(resultId, `üéâ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!`, 'success');
                    log(resultId, `‚ùÑÔ∏è –õ–µ–¥—è–Ω–æ–π —Å–∫–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω –≤ –∏–≥—Ä–µ`, 'success');
                } else {
                    log(resultId, `‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ—à–ª–∏`, 'warning');
                    log(resultId, `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–Ω –µ—â–µ —Ä–∞–∑`, 'warning');
                }

            } catch (error) {
                log(resultId, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function goToGame() {
            if (window.opener) {
                window.close();
            } else {
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
